# Diagnostics & Error Reporting System

This document explains the built-in diagnostics and error reporting system for the Next.js application.

## Overview

The diagnostics system provides:
- Centralized logging with multiple levels (debug, info, warn, error)
- Global error capture for client-side errors
- React Error Boundary for graceful error handling
- Development debug panel for real-time error monitoring
- Request tracing with unique IDs
- API endpoints for log management

## Debug Panel

### Toggle the Debug Panel
Press `Ctrl+Shift+L` to toggle the debug panel on/off.

The debug panel shows:
- Recent logs with filtering by level
- Error statistics
- Last error with copy and GitHub issue generation
- Real-time log updates

### Features
- **Copy to Clipboard**: Copy error details as JSON
- **GitHub Issue**: Generate formatted GitHub issue text
- **Level Filtering**: Filter logs by debug, info, warn, or error
- **Auto-refresh**: Automatically fetches new logs

## Using the Logger

### Basic Usage
```typescript
import { logger } from '@/lib/logger';

// Log at different levels
logger.debug('Debug information', { userId: 123 });
logger.info('User action completed');
logger.warn('Deprecated API used', { api: 'old-endpoint' });
logger.error('Database connection failed', error.stack, { database: 'main' });
```

### Error Handling
```typescript
import { logClientError } from '@/lib/logger';

try {
  // Some operation that might fail
  await riskyOperation();
} catch (error) {
  logClientError(error, { 
    operation: 'riskyOperation',
    userId: currentUser.id 
  });
}
```

## API Endpoints

### Health Check
- **GET** `/api/_health` - Returns application health status
- Response includes build time, commit hash, and environment info

### Logging
- **POST** `/api/_log` - Submit log entries (dev only)
- **GET** `/api/_logs` - Retrieve recent logs (dev only)
  - Query params: `level`, `limit`
  - Example: `/api/_logs?level=error&limit=20`

## Request Tracing

Every request gets a unique `x-request-id` header for tracing:
- Automatically generated by middleware
- Included in all log entries
- Helps correlate errors across the request lifecycle

## Error Boundary

The React Error Boundary catches component errors and:
- Displays a user-friendly error message
- Logs the error with full context
- Provides "Copy Details" and "Report Error" buttons in development
- Includes component stack trace in error details

## Workspace Root Warning Fix

If you see the warning about multiple lockfiles:

### Option A (Recommended)
Delete the stray lockfile at `C:\Users\marke\package-lock.json`

### Option B (Implemented)
The `next.config.ts` includes `outputFileTracingRoot` configuration to resolve the warning.

## Environment Configuration

Set `NEXT_PUBLIC_DEBUG=1` in `.env.local` to enable:
- Debug panel
- Enhanced error logging
- Development-only features

## Sample Error Payload

```json
{
  "level": "error",
  "message": "Database connection failed",
  "stack": "Error: Connection timeout\n    at Database.connect (db.js:45:12)\n    at async handler (api.js:23:8)",
  "context": {
    "database": "main",
    "timeout": 5000,
    "retries": 3
  },
  "timestamp": "2024-01-15T10:30:45.123Z",
  "requestId": "req_abc123def456"
}
```

## Development Scripts

### View Logs
```bash
# Start dev server and fetch logs
npm run logs
```

### Manual Log Fetching
```bash
curl "http://localhost:3000/api/_logs?level=error&limit=10"
```

## Best Practices

1. **Use appropriate log levels**:
   - `debug`: Development debugging info
   - `info`: Normal application flow
   - `warn`: Potential issues
   - `error`: Actual errors that need attention

2. **Include context**: Always provide relevant context in log entries
3. **Use request IDs**: Include request IDs when filing bug reports
4. **Test error scenarios**: Use the debug panel to verify error capture
5. **Monitor in development**: Keep the debug panel open during development

## Security Notes

- Logging endpoints are disabled in production
- Sensitive data should not be included in log context
- Request IDs are safe to share in bug reports
- Debug panel only appears when `NEXT_PUBLIC_DEBUG=1`
